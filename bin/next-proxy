#!/usr/bin/env node
import parseArgs from 'minimist'
import buildProxy from '../server/proxy'
import { resolve } from 'path'

const argv = parseArgs(process.argv.slice(2), {
  alias: {
    h: 'help',
    H: 'hostname',
    p: 'port',
    r: 'rules-file'
  },
  boolean: ['h'],
  string: ['H', 'r'],
  default: { p: 9000, H: 'localhost' }
})

if (!argv['rules-file']) {
  console.error(`> Start the proxy with --rules-file (-r) option\n`)
  process.exit(1)
}

if (argv.help) {
  console.log(`
    Description
      Start a proxy for different Next.js zones.

    Usage
      $ next proxy -r <rules.js> -p <port> 

    Options
      --rules-file, -r      A .json file which contains rules for the proxy
      --port, -p            A port number on which to start the application
      --hostname, -H        Hostname on which to start the application
      --help, -h            Displays this message
  `)
  process.exit(0)
}

const rulesFilePath = resolve(process.cwd(), argv['rules-file'])
const { rules } = require(rulesFilePath)
const proxy = buildProxy(rules)
proxy.listen(argv.port, argv.hostname, (err) => {
  if (err) {
    throw err
  }

  console.log(`> Ready on http://${argv.hostname}:${argv.port}`)
})
